<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Rapport d'activité</title>

    <!-- Bootstrap 5 (retire cette ligne si déjà chargé par ton Print Format) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- wkhtmltopdf / pdfkit options (reconnus par ERPNext) -->
    <meta name="pdfkit-orientation" content="Landscape" />
    <!-- Optionnel : réduis légèrement les marges/zoom si ça déborde encore -->
    <meta name="pdfkit-margin-left" content="8mm" />
    <meta name="pdfkit-margin-right" content="8mm" />
    <meta name="pdfkit-margin-top" content="10mm" />
    <meta name="pdfkit-margin-bottom" content="10mm" />
    <!-- Si nécessaire, active (dé)commente : <meta name="pdfkit-zoom" content="0.95"/> -->

    <style>
        /* Reset fond écran ERPNext */
        body {
            background: #f6f7fb;
            padding: 0 !important;
            margin: 0 !important;
        }

        /* Conteneur Print Format ERPNext */
        .print-format {
            padding: 15px;
        }

        /* A4 paysage + marges CSS (utile aussi pour l'aperçu navigateur) */
        @page {
            size: A4 landscape;
            margin: 10mm;
            /* doublon volontaire avec les metas pdfkit, les deux sont OK */
        }

        /* Dimensions “logiques” en mode impression pour l’aperçu navigateur */
        @media print {

            html,
            body {
                width: 297mm;
                height: 210mm;
            }

            /* Empêcher la découpe et le masquage horizontal : voir wkhtmltopdf */
            .table-responsive {
                overflow: visible !important;
            }

            /* Forcer un tableau compact pour 31 colonnes */
            table.table {
                table-layout: fixed;
            }

            table.table th,
            table.table td {
                padding: 2px 3px !important;
                /* padding réduit */
                font-size: 11px !important;
                /* police réduite */
                vertical-align: middle;
                white-space: nowrap;
                /* pas de retour dans les cellules jour */
            }

            /* La 1re colonne peut revenir à la ligne pour conserver la lisibilité */
            table.table th:first-child,
            table.table td:first-child {
                width: 180px;
                white-space: normal;
                word-break: break-word;
            }
        }

        /* Styles généraux table */
        table.table th,
        table.table td {
            border: 1px solid #999 !important;
            font-size: 12px;
            vertical-align: middle;
        }

        table.table thead th {
            background: #999 !important;
            color: #fff;
            text-align: center;
        }

        /* Couleurs imprimables */
        .bg-cyan {
            background: #CFF0FF !important;
        }

        .bg-yellow {
            background: #FAF1B8 !important;
        }

        /* Titres */
        h1,
        h2,
        h4 {
            margin: 0;
        }

        /* Utilitaires */
        .text-12 {
            font-size: 12px;
        }

        .text-13 {
            font-size: 13px;
        }

        .border-1 {
            border: 1px solid #999;
        }
    </style>
</head>

<body>
    <div class="w-100 m-0 p-0 print-format">

        {# --------- Préparation des données (Jinja) --------- #}
  {% set base_date = doc.start_date or doc.from_date or (doc.posting_date if doc.posting_date else None) %}
  {% set month_label = base_date and frappe.utils.formatdate(base_date, "MMMM yyyy") or "" %}
  {# dictionnaire: projects -> { day_number: 1 } #}
  {% set ns = namespace(projects={}, all_days={}) %}
  {% for row in doc.time_logs or [] %}
    {% set p = row.project or row.activity_type or _("Sans projet") %}
    {% set daynum = frappe.utils.getdate(row.from_time).day if row.from_time else None %}
    {% if daynum %}
      {% if not ns.projects.get(p) %}
        {% set _ = ns.projects.update({p: {}}) %}
      {% endif %}
      {% set _ = ns.projects[p].update({ daynum: 1 }) %}
      {% set _ = ns.all_days.update({ daynum: 1 }) %}
    {% endif %}
  {% endfor %}
  {# nombre de jours distincts #}
  {% set total_days = doc.custom_total_working_days or "-" %}
  {% set company = frappe.get_doc('Company', doc.company) or "-" %}
  {% set customer = frappe.get_doc('Customer', doc.customer) or "-" %}
  {% set customer_contact = frappe.get_doc('Contact', customer.customer_primary_contact) %}
  

        <!-- En-tête -->
        <header class="mb-2">
            <div class="text-center py-2 border border-2">
                <h4 class="fw-bold">Rapport d'activité de {{ doc.employee_name }} - {{month_label}} </h4>
            </div>

            <div class="row align-items-center g-4 mt-2">
                <div class="col-12 col-md-3 text-md-start text-center">
                    <img src="https://erp-dev.amoaman.com/files/Logo%20AMOAMAN%20new.jpg" alt="Logo"
                        style="max-width: 150px; height: auto;" />
                </div>

                <div class="col-12 col-md-4">
                    <div class="border p-3 text-13">
                        <div class="text-center mb-2">
                            <h4 class="fw-semibold">Prestataire</h4>
                        </div>
                        <div class="d-flex gap-2">
                            <span class="fw-semibold">Société&nbsp;:</span>
                            <span>{{ company.name }}<br /> {{ company.company_description }}</span>
                        </div>
                        <div class="d-flex gap-2">
                            <span class="fw-semibold">Adresse&nbsp;:</span>
                            <span>{{ company.custom_adresse }}</span>
                        </div>
                        <div class="d-flex gap-2">
                            <span class="fw-semibold">Contact&nbsp;:</span>
                            <span>{{ company.custom_nom_complet_du_représentant_légal_ }}</span>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-5">
                    <div class="border p-3 text-13">
                        <div class="text-center mb-2">
                            <h4 class="fw-semibold">Client</h4>
                        </div>
                        <div class="d-flex gap-2">
                            <span class="fw-semibold">Société&nbsp;:</span>
                            <span>{{customer.customer_name }}</span>
                        </div>
                        <div class="d-flex gap-2">
                            <span class="fw-semibold">Adresse&nbsp;:</span>
                            <span>{{ customer.custom_adresse }}</span>
                        </div>
                        <div class="d-flex gap-2">
                            <span class="fw-semibold">Contact&nbsp;:</span>
                            <span>{{ customer_contact.full_name }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Corps -->
        <main>
            <h2 class="fw-semibold fs-5 mb-2">Activité normale</h2>
            <div class="table-responsive">
                {% set ctx = build_time_log_rows(doc) %}
                <table class="table table-bordered table-sm">
                <thead>
                    <tr>
                    <th>Projet / Type d'activité</th>
                    {% for i in range(1, ctx.header_days_count + 1) %}
                        <th>{{ i }}</th>
                    {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% if ctx.rows and ctx.header_dates %}
                    {% for row in ctx.rows %}
                        <tr>
                        <td>{{ row.label }}</td>
                        {% for c in row.cells %}
                            <td class="{{ c.cls }}">{{ c.val }}</td>
                        {% endfor %}
                        </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="999">Aucune donnée à afficher.</td>
                    </tr>
                    {% endif %}
                </tbody>
                </table>
            </div>

            <div class="mt-2 mb-2">
                <span class="fw-semibold">Total&nbsp;:</span> {{total_days}} jrs
            </div>

            <div class="row g-4">
                <div class="col-12 col-md-6">
                    <div class="border-1 p-3" style="height: 150px;">
                        <div class="d-flex gap-2">
                            <span class="fw-semibold">Date&nbsp;:</span>
                        </div>
                        <div class="d-flex gap-2 mt-2">
                            <span class="fw-semibold">Nom Client&nbsp;:</span>
                            <span>&nbsp;</span>
                        </div>
                        <div class="d-flex gap-2 mt-2">
                            <span class="fw-semibold">Signature Client&nbsp;:</span>
                            <span>&nbsp;</span>
                        </div>
                    </div>
                </div>

                
            </div>
        </main>

    </div>
</body>

</html>